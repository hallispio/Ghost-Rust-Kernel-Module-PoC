# /workspaces/rust/workspace/src/chrono-kernel-core/Makefile

KDIR := /workspaces/rust/workspace/local-kernel
PWD  := $(shell pwd)

TARGET := x86_64-unknown-none
RUST_OUT := target/$(TARGET)/release/libghost_shell.a
LOCAL_LIB := libghost_shell_static.a

# ğŸ”¥ [ìˆ˜ì •] ghost_shell-objs ëŒ€ì‹  -yë¥¼ ì“°ê³ , ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ê²°í•©
obj-m += ghost_shell.o
ghost_shell-y := shim.o $(LOCAL_LIB)

all:
	@echo "ğŸ”¥ [Step 1] Rust ë¹Œë“œ ì¤‘..."
	cargo build --release --target $(TARGET) -Z build-std
	
	@echo "ğŸ”¥ [Step 2] ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ë° ë§í¬..."
	cp $(RUST_OUT) ./$(LOCAL_LIB)
	# ì»¤ë„ ë¹Œë“œ ì‹œìŠ¤í…œì„ ì†ì´ëŠ” .cmd íŒŒì¼ ìƒì„±
	@touch .$(LOCAL_LIB).cmd
	
	@echo "ğŸ”¥ [Step 3] ì»¤ë„ ëª¨ë“ˆ ë¹Œë“œ..."
	# KBUILD_MODPOST_WARN=1ë¡œ ì‹¬ë³¼ ì²´í¬ ìœ ì—°í•˜ê²Œ í†µê³¼
	$(MAKE) -C $(KDIR) M=$(PWD) KBUILD_MODPOST_WARN=1 modules

clean:
	cargo clean
	$(MAKE) -C $(KDIR) M=$(PWD) clean
	rm -f $(LOCAL_LIB) .$(LOCAL_LIB).cmd