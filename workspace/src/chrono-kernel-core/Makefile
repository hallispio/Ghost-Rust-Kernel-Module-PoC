# Makefile (Nightly + Traffic Control Edition)

KDIR ?= /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

# ì„¤ì • íŒŒì¼(.cargo/config.toml) ë¯¿ê³  ê°‘ë‹ˆë‹¤.
TARGET := x86_64-unknown-linux-gnu
RUST_TARGET_DIR := target/$(TARGET)/release
RUST_LIB := $(RUST_TARGET_DIR)/libchrono_kernel_core.a

obj-m += ghost_shell.o
ghost_shell-y := shim.o $(RUST_LIB)

all:
	@echo "ğŸ”¥ [GHOST] Cleaning legacy artifacts..."
	# ì°Œêº¼ê¸° ë•Œë¬¸ì— ì•ˆ ë  ìˆ˜ ìˆìœ¼ë‹ˆ target í´ë” ê³¼ê°íˆ ì‚­ì œ (ì´ë²ˆì—” í•„ìˆ˜)
	rm -rf target/
	
	@echo "ğŸ”¥ [GHOST] Rust Re-build (Config Driven)..."
	# Nightly ì‚¬ìš© (ì„¤ì • íŒŒì¼ì´ ì˜µì…˜ ë‹¤ ê°€ì§€ê³  ìˆìŒ)
	cargo +nightly build --release
	
	@echo "ğŸ”¥ [GHOST] Dummy Receipt..."
	@mkdir -p $(RUST_TARGET_DIR)
	touch $(RUST_TARGET_DIR)/.libchrono_kernel_core.a.cmd
	
	@echo "ğŸ”¥ [GHOST] Linking..."
	$(MAKE) -C $(KDIR) M=$(PWD) modules KBUILD_MODPOST_WARN=1
	
	@echo "âœ… Build Complete."

clean:
	cargo clean
	$(MAKE) -C $(KDIR) M=$(PWD) clean